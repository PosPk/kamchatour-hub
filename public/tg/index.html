<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Kamchatour — Витрина</title>
    <style>
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:#f8fafc;color:#0f172a}
      .wrap{padding:16px}
      .grid{display:grid;grid-template-columns:1fr;gap:12px}
      .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden}
      .cover{width:100%;height:160px;object-fit:cover;background:#e2e8f0}
      .pad{padding:12px}
      .title{font-weight:800}
      .meta{color:#475569;margin-top:4px}
      .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
      .price{color:#065f46;font-weight:800}
      .btn{display:inline-block;background:#0891b2;color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none}
    </style>
    <script>
      function getLang(){
        const p=new URLSearchParams(location.search);
        const urlLang=(p.get('lang')||'').toLowerCase();
        if(urlLang) return urlLang;
        try{
          const tg = (window as any).Telegram && (window as any).Telegram.WebApp;
          const lc = tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.language_code;
          if(lc){ if(lc.toLowerCase().startsWith('zh')) return 'zh'; if(lc.toLowerCase().startsWith('ru')) return 'ru'; }
        }catch(_){ }
        const nav=(navigator.language||'').toLowerCase();
        if(nav.startsWith('zh')) return 'zh';
        if(nav.startsWith('ru')) return 'ru';
        return 'ru';
      }
      function pickI18n(obj,key,lang){
        const base=obj[key];const i18n=(obj[key+"_i18n"]||{});
        return (i18n && i18n[lang]) || base;
      }
      async function loadTours(){
        try{
          const res = await fetch('/api/tg/tours',{cache:'no-store'});
          if(res.ok){
            const json = await res.json();
            const items = Array.isArray(json?.items)? json.items: [];
            const lang=getLang();
            return items.map(x=>({
              id: x.id,
              title: pickI18n(x,'title',lang),
              img: x.image || 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
              meta: `${x.activity || ''} • ${x.region || ''}`.trim(),
              price: (x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+ ' ₽' : 'по запросу')
            }));
          }
          const res2 = await fetch('/partner-tours.json',{cache:'no-store'});
          if(!res2.ok) return [];
          const data = await res2.json();
          const lang=getLang();
          return data.map(x=>({
            id: x.id,
            title: pickI18n(x,'title',lang),
            img: x.image,
            meta: `${x.activity || ''} • ${x.region || ''}`.trim(),
            price: (x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+ ' ₽' : 'по запросу')
          }));
        }catch(_){ return []; }
      }
    </script>
  </head>
  <body>
    <div class="wrap">
      <h1 class="title">Туры Камчатки</h1>
      <div id="list" class="grid"></div>
    </div>
    <script>
      (async()=>{
        const tours = await loadTours();
        const el=document.getElementById('list');
        (tours.length? tours:[]).forEach(t=>{
          const c=document.createElement('div');c.className='card';
          const lang=getLang();
          const url=`/tg/tour.html?id=${encodeURIComponent(t.id)}&lang=${lang}`;
          c.innerHTML=`<img class="cover" src="${t.img}"/><div class="pad"><div class="title">${t.title}</div><div class="meta">${t.meta}</div><div class="row"><div class="price">${t.price}</div><a class="btn" href="${url}">Подробнее</a></div></div>`;
          el.appendChild(c);
        });
      })();
    </script>
  </body>
  </html>

