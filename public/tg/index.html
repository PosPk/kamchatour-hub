<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Kamchatour — Витрина</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:#f8fafc;color:#0f172a}
      .wrap{padding:16px;padding-bottom:92px}
      .grid{display:grid;grid-template-columns:1fr;gap:12px}
      .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden}
      .cover{width:100%;height:160px;object-fit:cover;background:#e2e8f0}
      .pad{padding:12px}
      .title{font-weight:800}
      .meta{color:#475569;margin-top:4px}
      .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
      .price{color:#065f46;font-weight:800}
      .btn{display:inline-block;background:#0891b2;color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none}
      .search{display:flex;gap:8px;margin-bottom:12px}
      .input{flex:1;padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
      .empty{padding:24px;text-align:center;color:#64748b}
      .bottom{position:fixed;left:0;right:0;bottom:0;display:flex;gap:24px;justify-content:space-around;padding:10px 16px;background:#fff;border-top:1px solid #e2e8f0;z-index:999}
      .link{color:#0f172a;text-decoration:none;padding:8px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;width:56px;height:48px;border:1px solid #e2e8f0}
      .link svg{width:22px;height:22px;display:block}
      .modal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:flex-end}
      .sheet{background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;width:100%}
      .row2{display:flex;gap:8px}
      .label{font-size:12px;color:#475569;margin:4px 0}
      .chips{display:flex;gap:8px;overflow:auto;padding-bottom:8px;margin-bottom:8px}
      .chip{display:flex;align-items:center;gap:6px;border:1px solid #e2e8f0;border-radius:999px;padding:8px 10px;background:#fff;color:#0f172a;white-space:nowrap}
      .chip svg{width:16px;height:16px}
      .chip.active{border-color:#0891b2;background:#e0f2fe}
    </style>
    <script>
      function initTelegram(){
        try{ var tg=window.Telegram && window.Telegram.WebApp; if(tg){ tg.expand(); tg.ready(); } }catch(_){ }
      }
      function getLang(){
        const p=new URLSearchParams(location.search);
        const urlLang=(p.get('lang')||'').toLowerCase();
        if(urlLang) return urlLang;
        try{
          const tg = (window as any).Telegram && (window as any).Telegram.WebApp;
          const lc = tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.language_code;
          if(lc){ if(lc.toLowerCase().startsWith('zh')) return 'zh'; if(lc.toLowerCase().startsWith('ru')) return 'ru'; }
        }catch(_){ }
        const nav=(navigator.language||'').toLowerCase();
        if(nav.startsWith('zh')) return 'zh';
        if(nav.startsWith('ru')) return 'ru';
        return 'ru';
      }
      function pickI18n(obj,key,lang){
        const base=obj[key];const i18n=(obj[key+"_i18n"]||{});
        return (i18n && i18n[lang]) || base;
      }
      async function loadTours(){
        try{
          const res = await fetch('/api/tg/tours',{cache:'no-store'});
          if(res.ok){
            const json = await res.json();
            const items = Array.isArray(json?.items)? json.items: [];
            const lang=getLang();
            return items.map(x=>({
              id: x.id,
              title: pickI18n(x,'title',lang),
              img: x.image || 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
              meta: `${x.activity || ''} • ${x.region || ''}`.trim(),
              price: (x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+ ' ₽' : 'по запросу')
            }));
          }
          const res2 = await fetch('/partner-tours.json',{cache:'no-store'});
          if(!res2.ok) return [];
          const data = await res2.json();
          const lang=getLang();
          return data.map(x=>({
            id: x.id,
            title: pickI18n(x,'title',lang),
            img: x.image,
            meta: `${x.activity || ''} • ${x.region || ''}`.trim(),
            price: (x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+ ' ₽' : 'по запросу')
          }));
        }catch(_){ return []; }
      }
    </script>
  </head>
  <body>
    <div class="wrap">
      <h1 class="title">Туры Камчатки</h1>
      <div class="search">
        <input id="q" class="input" type="search" placeholder="Поиск по названию и описанию"/>
        <a id="filtersBtn" class="btn" href="#">Фильтры</a>
      </div>
      <div id="chips" class="chips">
        <a class="chip" data-act="вулканы" href="#" title="Вулканы" aria-label="Вулканы">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 20l6-10 3 4 3-4 6 10z"/></svg>
          <span>Вулканы</span>
        </a>
        <a class="chip" data-act="долина гейзеров" href="#" title="Гейзеры" aria-label="Гейзеры">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-6"/><path d="M12 2v4"/><path d="M5 12h14"/><path d="M7 12c0-3 2-5 5-5s5 2 5 5"/></svg>
          <span>Гейзеры</span>
        </a>
        <a class="chip" data-act="хайкинг" href="#" title="Хайкинг" aria-label="Хайкинг">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="4" r="2"/><path d="M6 22l2-7 4-3 2 3 2 7"/></svg>
          <span>Хайкинг</span>
        </a>
        <a class="chip" data-act="медведи" href="#" title="Медведи" aria-label="Медведи">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="7" cy="7" r="3"/><circle cx="17" cy="7" r="3"/><path d="M3 16c2-3 5-5 9-5s7 2 9 5"/></svg>
          <span>Медведи</span>
        </a>
        <a class="chip" data-act="рыбалка" href="#" title="Рыбалка" aria-label="Рыбалка">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12s-3 5-10 5S2 12 2 12"/><path d="M11 12l-1-7 3 3-5 4"/></svg>
          <span>Рыбалка</span>
        </a>
        <a class="chip" data-act="морские туры" href="#" title="Море" aria-label="Море">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 17c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2"/></svg>
          <span>Море</span>
        </a>
        <a class="chip" data-act="киты" href="#" title="Киты" aria-label="Киты">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12c4 0 6-3 10-3s6 3 10 3c-1 3-4 6-8 6-5 0-9-3-12-6z"/><circle cx="8" cy="11" r="1"/></svg>
          <span>Киты</span>
        </a>
        <a class="chip" data-act="вертолёт" href="#" title="Вертолёт" aria-label="Вертолёт">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18"/><path d="M4 10h6l6 3h4"/><circle cx="6" cy="15" r="2"/><circle cx="18" cy="15" r="2"/></svg>
          <span>Вертолёт</span>
        </a>
        <a class="chip" data-act="снегоход" href="#" title="Снегоход" aria-label="Снегоход">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18h6l4-4 4 2 4 2"/><path d="M5 18l-3 2"/></svg>
          <span>Снегоход</span>
        </a>
        <a class="chip" data-act="дог-слидинг" href="#" title="Дог-слидинг" aria-label="Дог-слидинг">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 16l6 2 6-2 4 2"/><path d="M4 14l2-3 3 2 2-2"/></svg>
          <span>Дог‑слидинг</span>
        </a>
        <a class="chip" data-act="рафтинг" href="#" title="Рафтинг" aria-label="Рафтинг">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 15c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2"/><path d="M6 12l2-3m8 3l-2-3"/></svg>
          <span>Рафтинг</span>
        </a>
        <a class="chip" data-act="сёрфинг" href="#" title="Сёрфинг" aria-label="Сёрфинг">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18c3 0 3-2 6-2s3 2 6 2 3-2 6-2"/><path d="M10 6c2 2 2 4 0 6"/></svg>
          <span>Сёрфинг</span>
        </a>
        <a class="chip" data-act="термы" href="#" title="Термы" aria-label="Термы">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 18h12"/><path d="M8 14c0-2 2-3 4-3s4 1 4 3"/><path d="M10 10c-1-1-1-3 0-4"/></svg>
          <span>Термы</span>
        </a>
        <a class="chip" data-act="каякинг" href="#" title="Каякинг" aria-label="Каякинг">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12l10-6 10 6-10 6z"/><path d="M12 6v12"/></svg>
          <span>Каякинг</span>
        </a>
        <a class="chip" data-act="этно" href="#" title="Этно" aria-label="Этно">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3 7h7l-5.5 4 2.5 7-7-4-7 4 2.5-7L2 9h7z"/></svg>
          <span>Этно</span>
        </a>
        <a class="chip" data-act="фототур" href="#" title="Фототур" aria-label="Фототур">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"/><circle cx="12" cy="12" r="3"/></svg>
          <span>Фототур</span>
        </a>
        <a class="chip" data-act="4x4" href="#" title="4x4" aria-label="4x4">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="8" width="18" height="7" rx="2"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>
          <span>4x4</span>
        </a>
      </div>
      <div id="list" class="grid"></div>
    </div>
    <div id="filters" class="modal">
      <div class="sheet">
        <div class="label">Цена (₽)</div>
        <div class="row2">
          <input id="minPrice" class="input" type="number" placeholder="от"/>
          <input id="maxPrice" class="input" type="number" placeholder="до"/>
        </div>
        <div class="label">Активность</div>
        <input id="act" class="input" type="text" placeholder="рыбалка, вулканы..."/>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <a id="closeFilters" class="link" href="#">Отмена</a>
          <a id="applyFilters" class="btn" href="#">Применить</a>
        </div>
      </div>
    </div>
    <div class="bottom">
      <a class="link" href="/tg" title="Каталог" aria-label="Каталог">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18M3 10h18M3 16h18"/></svg>
      </a>
      <a class="link" href="/tg/ar.html" title="AR‑карта" aria-label="AR‑карта">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 11l9-7 9 7-9 7-9-7z"/><path d="M3 19l9-7 9 7"/></svg>
      </a>
      <a class="link" href="/tg/story.html" title="История" aria-label="История">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4v16"/><path d="M20 22V6H6.5A2.5 2.5 0 0 0 4 8.5"/></svg>
      </a>
      <a class="link" href="/tg/lead.html" title="Заявка" aria-label="Заявка">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></svg>
      </a>
    </div>
    <script>
      (async()=>{
        initTelegram();
        const all = await loadTours();
        const el=document.getElementById('list');
        const q=document.getElementById('q');
        const modal=document.getElementById('filters');
        const btn=document.getElementById('filtersBtn');
        const close=document.getElementById('closeFilters');
        const apply=document.getElementById('applyFilters');
        const minP=document.getElementById('minPrice');
        const maxP=document.getElementById('maxPrice');
        const act=document.getElementById('act');
        const chips=document.querySelectorAll('#chips .chip');
        function render(items){
          el.innerHTML='';
          const lang=getLang();
          if(!items || items.length===0){ el.innerHTML = '<div class="empty">Ничего не найдено. Попробуйте изменить запрос или фильтры.</div>'; return; }
          (items||[]).forEach(t=>{
            const c=document.createElement('a');
            c.href=`/tg/tour.html?id=${encodeURIComponent(t.id)}&lang=${lang}`;
            c.className='card';
            c.style.textDecoration='none';
            c.innerHTML=`<img class="cover" src="${t.img}"/><div class="pad"><div class="title">${t.title}</div><div class="meta">${t.meta}</div><div class="row"><div class="price">${t.price}</div><span class="btn">Подробнее</span></div></div>`;
            el.appendChild(c);
          });
        }
        function localFilter(items){
          const min = Number(minP.value)||0; const max = Number(maxP.value)||Infinity; const a = (act.value||'').toLowerCase();
          return (items||[]).filter((x)=>{
            const pr = Number((x.price_from||'').toString().replace(/\D/g,''))||0;
            const okPrice = pr>=min && pr<=max;
            const okAct = !a || (x.meta||'').toLowerCase().includes(a);
            return okPrice && okAct;
          });
        }
        async function searchRemote(query){
          const s=(query||'').trim();
          if(!s){ render(all); return; }
          try{
            const r=await fetch('/api/tg/search?q='+encodeURIComponent(s));
            if(!r.ok){ render(all); return; }
            const json=await r.json();
            let items=Array.isArray(json?.items)? json.items: [];
            items = localFilter(items);
            const lang=getLang();
            render(items.map(x=>({
              id:x.id,
              title:pickI18n(x,'title',lang),
              img:x.image||'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
              meta:`${x.activity||''} • ${x.region||''}`.trim(),
              price:(x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+' ₽':'по запросу')
            })));
          }catch(_){ render(all); }
        }
        let tmr; q.addEventListener('input',()=>{ clearTimeout(tmr); tmr=setTimeout(()=>searchRemote(q.value),200); });
        btn.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='flex'; });
        close.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='none'; });
        apply.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='none'; searchRemote(q.value); });
        chips.forEach((chip)=>{
          chip.addEventListener('click',(e)=>{
            e.preventDefault();
            const v = chip.getAttribute('data-act')||'';
            const isActive = chip.classList.contains('active');
            chips.forEach(c=>c.classList.remove('active'));
            if(isActive){ act.value=''; searchRemote(q.value); return; }
            chip.classList.add('active'); act.value = v; searchRemote(q.value);
          });
        });
        render(all);
      })();
    </script>
  </body>
  </html>

