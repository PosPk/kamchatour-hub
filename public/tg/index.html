<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Kamchatour — Витрина</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:#f8fafc;color:#0f172a}
      .wrap{padding:16px;padding-bottom:92px}
      .grid{display:grid;grid-template-columns:1fr;gap:12px}
      .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden}
      .cover{width:100%;height:160px;object-fit:cover;background:#e2e8f0}
      .pad{padding:12px}
      .title{font-weight:800}
      .meta{color:#475569;margin-top:4px}
      .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
      .price{color:#065f46;font-weight:800}
      .btn{display:inline-block;background:#0891b2;color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none}
      .search{display:flex;gap:8px;margin-bottom:12px}
      .input{flex:1;padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
      .empty{padding:24px;text-align:center;color:#64748b}
      .bottom{position:fixed;left:0;right:0;bottom:0;display:flex;gap:24px;justify-content:space-around;padding:10px 16px;background:#fff;border-top:1px solid #e2e8f0;z-index:999}
      .link{color:#0f172a;text-decoration:none;padding:8px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;width:56px;height:48px;border:1px solid #e2e8f0}
      .link svg{width:22px;height:22px;display:block}
      .modal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:flex-end}
      .sheet{background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;width:100%}
      .row2{display:flex;gap:8px}
      .label{font-size:12px;color:#475569;margin:4px 0}
    </style>
    <script>
      function initTelegram(){
        try{ var tg=window.Telegram && window.Telegram.WebApp; if(tg){ tg.expand(); tg.ready(); } }catch(_){ }
      }
      function getLang(){
        const p=new URLSearchParams(location.search);
        const urlLang=(p.get('lang')||'').toLowerCase();
        if(urlLang) return urlLang;
        try{
          const tg = (window as any).Telegram && (window as any).Telegram.WebApp;
          const lc = tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.language_code;
          if(lc){ if(lc.toLowerCase().startsWith('zh')) return 'zh'; if(lc.toLowerCase().startsWith('ru')) return 'ru'; }
        }catch(_){ }
        const nav=(navigator.language||'').toLowerCase();
        if(nav.startsWith('zh')) return 'zh';
        if(nav.startsWith('ru')) return 'ru';
        return 'ru';
      }
      function pickI18n(obj,key,lang){
        const base=obj[key];const i18n=(obj[key+"_i18n"]||{});
        return (i18n && i18n[lang]) || base;
      }
      async function loadTours(){
        try{
          const res = await fetch('/api/tg/tours',{cache:'no-store'});
          if(res.ok){
            const json = await res.json();
            const items = Array.isArray(json?.items)? json.items: [];
            const lang=getLang();
            return items.map(x=>({
              id: x.id,
              title: pickI18n(x,'title',lang),
              img: x.image || 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
              meta: `${x.activity || ''} • ${x.region || ''}`.trim(),
              price: (x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+ ' ₽' : 'по запросу')
            }));
          }
          const res2 = await fetch('/partner-tours.json',{cache:'no-store'});
          if(!res2.ok) return [];
          const data = await res2.json();
          const lang=getLang();
          return data.map(x=>({
            id: x.id,
            title: pickI18n(x,'title',lang),
            img: x.image,
            meta: `${x.activity || ''} • ${x.region || ''}`.trim(),
            price: (x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+ ' ₽' : 'по запросу')
          }));
        }catch(_){ return []; }
      }
    </script>
  </head>
  <body>
    <div class="wrap">
      <h1 class="title">Туры Камчатки</h1>
      <div class="search">
        <input id="q" class="input" type="search" placeholder="Поиск по названию и описанию"/>
        <a id="filtersBtn" class="btn" href="#">Фильтры</a>
      </div>
      <div id="list" class="grid"></div>
    </div>
    <div id="filters" class="modal">
      <div class="sheet">
        <div class="label">Цена (₽)</div>
        <div class="row2">
          <input id="minPrice" class="input" type="number" placeholder="от"/>
          <input id="maxPrice" class="input" type="number" placeholder="до"/>
        </div>
        <div class="label">Активность</div>
        <input id="act" class="input" type="text" placeholder="рыбалка, вулканы..."/>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <a id="closeFilters" class="link" href="#">Отмена</a>
          <a id="applyFilters" class="btn" href="#">Применить</a>
        </div>
      </div>
    </div>
    <div class="bottom">
      <a class="link" href="/tg" title="Каталог" aria-label="Каталог">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18M3 10h18M3 16h18"/></svg>
      </a>
      <a class="link" href="/tg/ar.html" title="AR‑карта" aria-label="AR‑карта">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 11l9-7 9 7-9 7-9-7z"/><path d="M3 19l9-7 9 7"/></svg>
      </a>
      <a class="link" href="/tg/lead" title="Заявка" aria-label="Заявка">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></svg>
      </a>
    </div>
    <script>
      (async()=>{
        initTelegram();
        const all = await loadTours();
        const el=document.getElementById('list');
        const q=document.getElementById('q');
        const modal=document.getElementById('filters');
        const btn=document.getElementById('filtersBtn');
        const close=document.getElementById('closeFilters');
        const apply=document.getElementById('applyFilters');
        const minP=document.getElementById('minPrice');
        const maxP=document.getElementById('maxPrice');
        const act=document.getElementById('act');
        function render(items){
          el.innerHTML='';
          const lang=getLang();
          if(!items || items.length===0){ el.innerHTML = '<div class="empty">Ничего не найдено. Попробуйте изменить запрос или фильтры.</div>'; return; }
          (items||[]).forEach(t=>{
            const c=document.createElement('a');
            c.href=`/tg/tour.html?id=${encodeURIComponent(t.id)}&lang=${lang}`;
            c.className='card';
            c.style.textDecoration='none';
            c.innerHTML=`<img class="cover" src="${t.img}"/><div class="pad"><div class="title">${t.title}</div><div class="meta">${t.meta}</div><div class="row"><div class="price">${t.price}</div><span class="btn">Подробнее</span></div></div>`;
            el.appendChild(c);
          });
        }
        function localFilter(items){
          const min = Number(minP.value)||0; const max = Number(maxP.value)||Infinity; const a = (act.value||'').toLowerCase();
          return (items||[]).filter((x)=>{
            const pr = Number((x.price_from||'').toString().replace(/\D/g,''))||0;
            const okPrice = pr>=min && pr<=max;
            const okAct = !a || (x.meta||'').toLowerCase().includes(a);
            return okPrice && okAct;
          });
        }
        async function searchRemote(query){
          const s=(query||'').trim();
          if(!s){ render(all); return; }
          try{
            const r=await fetch('/api/tg/search?q='+encodeURIComponent(s));
            if(!r.ok){ render(all); return; }
            const json=await r.json();
            let items=Array.isArray(json?.items)? json.items: [];
            items = localFilter(items);
            const lang=getLang();
            render(items.map(x=>({
              id:x.id,
              title:pickI18n(x,'title',lang),
              img:x.image||'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
              meta:`${x.activity||''} • ${x.region||''}`.trim(),
              price:(x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+' ₽':'по запросу')
            })));
          }catch(_){ render(all); }
        }
        let tmr; q.addEventListener('input',()=>{ clearTimeout(tmr); tmr=setTimeout(()=>searchRemote(q.value),200); });
        btn.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='flex'; });
        close.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='none'; });
        apply.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='none'; searchRemote(q.value); });
        render(all);
      })();
    </script>
  </body>
  </html>

