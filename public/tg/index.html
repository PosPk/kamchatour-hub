<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Kamchatour ‚Äî –í–∏—Ç—Ä–∏–Ω–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root{
        --tg-bg: var(--tg-theme-bg-color, #f8fafc);
        --tg-text: var(--tg-theme-text-color, #0f172a);
        --tg-hint: var(--tg-theme-hint-color, #64748b);
        --tg-button: var(--tg-theme-button-color, #0891b2);
        --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
        --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
      }
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--tg-bg);color:var(--tg-text)}
      .wrap{padding:16px;padding-bottom:92px}
      .grid{display:grid;grid-template-columns:1fr;gap:12px}
      .card{background:var(--tg-secondary-bg);border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;position:relative}
      .cover{width:100%;height:160px;object-fit:cover;background:#e2e8f0}
      .pad{padding:12px}
      .title{font-weight:800}
      .meta{color:var(--tg-hint);margin-top:4px}
      .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
      .price{color:#065f46;font-weight:800}
      .btn{display:inline-block;background:var(--tg-button);color:var(--tg-button-text);padding:10px 12px;border-radius:10px;text-decoration:none}
      .search{display:flex;gap:8px;margin-bottom:12px}
      .input{flex:1;padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
      .empty{padding:24px;text-align:center;color:#64748b}
      .bottom{position:fixed;left:0;right:0;bottom:12px;display:flex;gap:16px;justify-content:center;z-index:999}
      .bottom .dock{display:flex;gap:24px;justify-content:space-around;align-items:center;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);padding:10px 16px;border:1px solid #e2e8f0;border-radius:999px;box-shadow:0 10px 30px rgba(2,6,23,.15)}
      .link{color:#0f172a;text-decoration:none;border-radius:12px;background:transparent;display:flex;align-items:center;justify-content:center;width:56px;height:48px}
      .link svg{width:22px;height:22px;display:block}
      .modal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:flex-end}
      .sheet{background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;width:100%}
      .row2{display:flex;gap:8px}
      .label{font-size:12px;color:#475569;margin:4px 0}
      .chips{display:flex;gap:8px;overflow:auto;padding-bottom:8px;margin-bottom:8px}
      .chip{display:flex;align-items:center;gap:6px;border:1px solid #e2e8f0;border-radius:999px;padding:8px 10px;background:#fff;color:#0f172a;white-space:nowrap}
      .chip svg{width:16px;height:16px}
      .chip.active{border-color:var(--tg-button);background:color-mix(in srgb, var(--tg-button) 15%, #fff)}
      /* badges */
      .badges{position:absolute;top:8px;right:8px;display:flex;gap:6px}
      .badge{backdrop-filter:blur(4px);background:rgba(0,0,0,.55);color:#fff;border-radius:999px;padding:4px 8px;font-size:12px}
      .badge.eco{background:rgba(16,185,129,.85)}
      .badge.rating{background:rgba(234,179,8,.9)}
      /* skeleton */
      .skeleton{background:linear-gradient(90deg,#e5e7eb, #f3f4f6 40%, #e5e7eb 60%);background-size:200% 100%;animation:sh 1.2s infinite}
      @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
      .card.sk .cover{background:#e5e7eb}
      .card.sk .title,.card.sk .meta,.card.sk .price{height:14px;border-radius:6px}
    </style>
    <script>
      function initTelegram(){
        try{ var tg=window.Telegram && window.Telegram.WebApp; if(tg){ tg.expand(); tg.ready(); } }catch(_){ }
      }
      function getLang(){
        const p=new URLSearchParams(location.search);
        const urlLang=(p.get('lang')||'').toLowerCase();
        if(urlLang) return urlLang;
        try{
          const tg = window.Telegram && window.Telegram.WebApp;
          const lc = tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.language_code;
          if(lc){ if(lc.toLowerCase().startsWith('zh')) return 'zh'; if(lc.toLowerCase().startsWith('ru')) return 'ru'; }
        }catch(_){ }
        const nav=(navigator.language||'').toLowerCase();
        if(nav.startsWith('zh')) return 'zh';
        if(nav.startsWith('ru')) return 'ru';
        return 'ru';
      }
      function pickI18n(obj,key,lang){
        const base=obj[key];const i18n=(obj[key+"_i18n"]||{});
        return (i18n && i18n[lang]) || base;
      }
      function opt(u,w){
        try{
          if(!u) return u;
          if(u.includes('supabase.co/storage/v1/object/public/')){
            var url=new URL(u);
            url.pathname=url.pathname.replace('/object/public/','/render/image/public/');
            url.searchParams.set('width', String(w||720));
            url.searchParams.set('quality','70');
            url.searchParams.set('format','webp');
            return url.toString();
          }
          var noProto=u.replace(/^https?:\/\//,'');
          return 'https://images.weserv.nl/?url='+encodeURIComponent(noProto)+'&w='+(w||720)+'&q=70&output=webp';
        }catch(_){ return u; }
      }
      async function authIfPossible(){
        try{ var tg=window.Telegram&&window.Telegram.WebApp; var initData=tg&&tg.initData; if(initData){ await fetch('/api/tg/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData})}); } }catch(_){ }
      }
      async function loadTours(){
        try{
          const res = await fetch('/api/tg/tours',{cache:'no-store'});
          if(res.ok){
            const json = await res.json();
            const items = Array.isArray(json?.items)? json.items: [];
            const lang=getLang();
            return items.map(x=>({
              id: x.id,
              title: pickI18n(x,'title',lang),
              img: x.image || 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
              meta: `${x.activity || ''} ‚Ä¢ ${x.region || ''}`.trim(),
              price: (x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+ ' ‚ÇΩ' : '–ø–æ –∑–∞–ø—Ä–æ—Å—É'),
              eco_points: x.eco_points || 0,
              rating: x.rating || null,
              reviews: x.reviews || null,
              duration_days: x.duration_days || x.duration || null,
              price_from: x.price_from || null
            }));
          }
          const res2 = await fetch('/partner-tours.json',{cache:'no-store'});
          if(!res2.ok) return [];
          const data = await res2.json();
          const lang=getLang();
          return data.map(x=>({
            id: x.id,
            title: pickI18n(x,'title',lang),
            img: x.image,
            meta: `${x.activity || ''} ‚Ä¢ ${x.region || ''}`.trim(),
            price: (x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+ ' ‚ÇΩ' : '–ø–æ –∑–∞–ø—Ä–æ—Å—É'),
            eco_points: x.eco_points || 0,
            rating: x.rating || null,
            reviews: x.reviews || null,
            duration_days: x.duration_days || x.duration || null,
            price_from: x.price_from || null
          }));
        }catch(_){ return []; }
      }
    </script>
  </head>
  <body>
    <div class="wrap">
      <h1 class="title">–¢—É—Ä—ã –ö–∞–º—á–∞—Ç–∫–∏</h1>
      <div class="search">
        <input id="q" class="input" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é"/>
        <a id="searchBtn" class="btn" href="#">–ü–æ–∏—Å–∫</a>
        <a id="filtersBtn" class="btn" href="#">–§–∏–ª—å—Ç—Ä—ã</a>
      </div>
      <div id="chips" class="chips">
        <a class="chip" data-act="–≤—É–ª–∫–∞–Ω—ã" href="#" title="–í—É–ª–∫–∞–Ω—ã" aria-label="–í—É–ª–∫–∞–Ω—ã">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 20l6-10 3 4 3-4 6 10z"/></svg>
          <span>–í—É–ª–∫–∞–Ω—ã</span>
        </a>
        <a class="chip" data-act="–¥–æ–ª–∏–Ω–∞ –≥–µ–π–∑–µ—Ä–æ–≤" href="#" title="–ì–µ–π–∑–µ—Ä—ã" aria-label="–ì–µ–π–∑–µ—Ä—ã">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-6"/><path d="M12 2v4"/><path d="M5 12h14"/><path d="M7 12c0-3 2-5 5-5s5 2 5 5"/></svg>
          <span>–ì–µ–π–∑–µ—Ä—ã</span>
        </a>
        <a class="chip" data-act="—Ö–∞–π–∫–∏–Ω–≥" href="#" title="–•–∞–π–∫–∏–Ω–≥" aria-label="–•–∞–π–∫–∏–Ω–≥">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="4" r="2"/><path d="M6 22l2-7 4-3 2 3 2 7"/></svg>
          <span>–•–∞–π–∫–∏–Ω–≥</span>
        </a>
        <a class="chip" data-act="–º–µ–¥–≤–µ–¥–∏" href="#" title="–ú–µ–¥–≤–µ–¥–∏" aria-label="–ú–µ–¥–≤–µ–¥–∏">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="7" cy="7" r="3"/><circle cx="17" cy="7" r="3"/><path d="M3 16c2-3 5-5 9-5s7 2 9 5"/></svg>
          <span>–ú–µ–¥–≤–µ–¥–∏</span>
        </a>
        <a class="chip" data-act="—Ä—ã–±–∞–ª–∫–∞" href="#" title="–†—ã–±–∞–ª–∫–∞" aria-label="–†—ã–±–∞–ª–∫–∞">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12s-3 5-10 5S2 12 2 12"/><path d="M11 12l-1-7 3 3-5 4"/></svg>
          <span>–†—ã–±–∞–ª–∫–∞</span>
        </a>
        <a class="chip" data-act="–º–æ—Ä—Å–∫–∏–µ —Ç—É—Ä—ã" href="#" title="–ú–æ—Ä–µ" aria-label="–ú–æ—Ä–µ">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 17c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2"/></svg>
          <span>–ú–æ—Ä–µ</span>
        </a>
        <a class="chip" data-act="–∫–∏—Ç—ã" href="#" title="–ö–∏—Ç—ã" aria-label="–ö–∏—Ç—ã">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12c4 0 6-3 10-3s6 3 10 3c-1 3-4 6-8 6-5 0-9-3-12-6z"/><circle cx="8" cy="11" r="1"/></svg>
          <span>–ö–∏—Ç—ã</span>
        </a>
        <a class="chip" data-act="–≤–µ—Ä—Ç–æ–ª—ë—Ç" href="#" title="–í–µ—Ä—Ç–æ–ª—ë—Ç" aria-label="–í–µ—Ä—Ç–æ–ª—ë—Ç">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18"/><path d="M4 10h6l6 3h4"/><circle cx="6" cy="15" r="2"/><circle cx="18" cy="15" r="2"/></svg>
          <span>–í–µ—Ä—Ç–æ–ª—ë—Ç</span>
        </a>
        <a class="chip" data-act="—Å–Ω–µ–≥–æ—Ö–æ–¥" href="#" title="–°–Ω–µ–≥–æ—Ö–æ–¥" aria-label="–°–Ω–µ–≥–æ—Ö–æ–¥">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18h6l4-4 4 2 4 2"/><path d="M5 18l-3 2"/></svg>
          <span>–°–Ω–µ–≥–æ—Ö–æ–¥</span>
        </a>
        <a class="chip" data-act="–¥–æ–≥-—Å–ª–∏–¥–∏–Ω–≥" href="#" title="–î–æ–≥-—Å–ª–∏–¥–∏–Ω–≥" aria-label="–î–æ–≥-—Å–ª–∏–¥–∏–Ω–≥">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 16l6 2 6-2 4 2"/><path d="M4 14l2-3 3 2 2-2"/></svg>
          <span>–î–æ–≥‚Äë—Å–ª–∏–¥–∏–Ω–≥</span>
        </a>
        <a class="chip" data-act="—Ä–∞—Ñ—Ç–∏–Ω–≥" href="#" title="–†–∞—Ñ—Ç–∏–Ω–≥" aria-label="–†–∞—Ñ—Ç–∏–Ω–≥">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 15c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2"/><path d="M6 12l2-3m8 3l-2-3"/></svg>
          <span>–†–∞—Ñ—Ç–∏–Ω–≥</span>
        </a>
        <a class="chip" data-act="—Å—ë—Ä—Ñ–∏–Ω–≥" href="#" title="–°—ë—Ä—Ñ–∏–Ω–≥" aria-label="–°—ë—Ä—Ñ–∏–Ω–≥">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18c3 0 3-2 6-2s3 2 6 2 3-2 6-2"/><path d="M10 6c2 2 2 4 0 6"/></svg>
          <span>–°—ë—Ä—Ñ–∏–Ω–≥</span>
        </a>
        <a class="chip" data-act="—Ç–µ—Ä–º—ã" href="#" title="–¢–µ—Ä–º—ã" aria-label="–¢–µ—Ä–º—ã">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 18h12"/><path d="M8 14c0-2 2-3 4-3s4 1 4 3"/><path d="M10 10c-1-1-1-3 0-4"/></svg>
          <span>–¢–µ—Ä–º—ã</span>
        </a>
        <a class="chip" data-act="–∫–∞—è–∫–∏–Ω–≥" href="#" title="–ö–∞—è–∫–∏–Ω–≥" aria-label="–ö–∞—è–∫–∏–Ω–≥">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12l10-6 10 6-10 6z"/><path d="M12 6v12"/></svg>
          <span>–ö–∞—è–∫–∏–Ω–≥</span>
        </a>
        <a class="chip" data-act="—ç—Ç–Ω–æ" href="#" title="–≠—Ç–Ω–æ" aria-label="–≠—Ç–Ω–æ">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3 7h7l-5.5 4 2.5 7-7-4-7 4 2.5-7L2 9h7z"/></svg>
          <span>–≠—Ç–Ω–æ</span>
        </a>
        <a class="chip" data-act="—Ñ–æ—Ç–æ—Ç—É—Ä" href="#" title="–§–æ—Ç–æ—Ç—É—Ä" aria-label="–§–æ—Ç–æ—Ç—É—Ä">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"/><circle cx="12" cy="12" r="3"/></svg>
          <span>–§–æ—Ç–æ—Ç—É—Ä</span>
        </a>
        <a class="chip" data-act="4x4" href="#" title="4x4" aria-label="4x4">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="8" width="18" height="7" rx="2"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>
          <span>4x4</span>
        </a>
      </div>
      <div id="list" class="grid"></div>
    </div>
    <div id="filters" class="modal">
      <div class="sheet">
        <div class="label">–¶–µ–Ω–∞ (‚ÇΩ)</div>
        <div class="row2">
          <input id="minPrice" class="input" type="number" placeholder="–æ—Ç"/>
          <input id="maxPrice" class="input" type="number" placeholder="–¥–æ"/>
        </div>
        <div class="label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π)</div>
        <div class="row2">
          <input id="minDays" class="input" type="number" placeholder="–æ—Ç"/>
          <input id="maxDays" class="input" type="number" placeholder="–¥–æ"/>
        </div>
        <div class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
        <input id="act" class="input" type="text" placeholder="—Ä—ã–±–∞–ª–∫–∞, –≤—É–ª–∫–∞–Ω—ã..."/>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <a id="closeFilters" class="link" href="#">–û—Ç–º–µ–Ω–∞</a>
          <a id="applyFilters" class="btn" href="#">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</a>
        </div>
      </div>
    </div>
    <div class="bottom"><div class="dock">
      <a class="link" href="/tg" title="–ö–∞—Ç–∞–ª–æ–≥" aria-label="–ö–∞—Ç–∞–ª–æ–≥">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18M3 10h18M3 16h18"/></svg>
      </a>
      <a class="link" href="/tg/map.html" title="–ö–∞—Ä—Ç–∞" aria-label="–ö–∞—Ä—Ç–∞">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6l6-3 6 3 6-3v15l-6 3-6-3-6 3z"/><path d="M9 3v15"/><path d="M15 6v15"/></svg>
      </a>
      <a class="link" href="/tg/story.html" title="–ò—Å—Ç–æ—Ä–∏—è" aria-label="–ò—Å—Ç–æ—Ä–∏—è">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4v16"/><path d="M20 22V6H6.5A2.5 2.5 0 0 0 4 8.5"/></svg>
      </a>
      <a class="link" href="/tg/events.html" title="–°–æ–±—ã—Ç–∏—è" aria-label="–°–æ–±—ã—Ç–∏—è">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      </a>
      <a class="link" href="/tg/lead.html" title="–ó–∞—è–≤–∫–∞" aria-label="–ó–∞—è–≤–∫–∞">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></svg>
      </a>
      <a class="link" href="/tg/account.html" title="–ê–∫–∫–∞—É–Ω—Ç" aria-label="–ê–∫–∫–∞—É–Ω—Ç">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M6 20c0-3.3137 2.6863-6 6-6s6 2.6863 6 6"/></svg>
      </a>
    </div></div>
    <script>
      (async()=>{
        initTelegram();
        authIfPossible();
        const all = await loadTours();
        const el=document.getElementById('list');
        const q=document.getElementById('q');
        const modal=document.getElementById('filters');
        const btn=document.getElementById('filtersBtn');
        const sbtn=document.getElementById('searchBtn');
        const close=document.getElementById('closeFilters');
        const apply=document.getElementById('applyFilters');
        const minP=document.getElementById('minPrice');
        const maxP=document.getElementById('maxPrice');
        const minD=document.getElementById('minDays');
        const maxD=document.getElementById('maxDays');
        const act=document.getElementById('act');
        const chips=document.querySelectorAll('#chips .chip');
        function render(items){
          el.innerHTML='';
          const lang=getLang();
          if(!items || items.length===0){
            el.innerHTML = '<div class="empty">üêª –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.<br/>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫ –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.</div>';
            return;
          }
          (items||[]).forEach(t=>{
            const c=document.createElement('a');
            c.href=`/tg/tour.html?id=${encodeURIComponent(t.id)}&lang=${lang}`;
            c.className='card';
            c.style.textDecoration='none';
            const eco = (t.eco_points||0)>0? `<span class="badge eco">‚ôªÔ∏è Eco+${t.eco_points}</span>`:'';
            const rating = t.rating? `<span class="badge rating">‚òÖ ${t.rating}${t.reviews? ` (${t.reviews})`:''}</span>`:'';
            const s360=opt(t.img,360), s720=opt(t.img,720), s1080=opt(t.img,1080);
            const srcset=`${s360} 360w, ${s720} 720w, ${s1080} 1080w`;
            c.innerHTML=`<div class="badges">${eco}${rating}</div><img class="cover" src="${s720}" srcset="${srcset}" sizes="(max-width: 640px) 100vw, 640px" loading="lazy" decoding="async" width="640" height="160"/><div class="pad"><div class="title">${t.title}</div><div class="meta">${t.meta}</div><div class="row"><div class="price">${t.price}</div><span class="btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</span></div></div>`;
            el.appendChild(c);
          });
        }
        // show skeletons while loading initial
        (function showSkeleton(){
          const skeletonGrid=document.getElementById('list'); skeletonGrid.innerHTML='';
          for(let i=0;i<4;i++){
            const s=document.createElement('div'); s.className='card sk'; s.innerHTML=`<div class="cover skeleton"></div><div class="pad"><div class="title skeleton" style="width:70%"></div><div class="meta skeleton" style="width:40%;margin-top:6px"></div><div class="row"><div class="price skeleton" style="width:80px"></div><span class="btn skeleton" style="width:96px;height:36px;border-radius:10px"></span></div></div>`; skeletonGrid.appendChild(s);
          }
        })();
        function localFilter(items){
          const min = Number(minP.value)||0; const max = Number(maxP.value)||Infinity; const a = (act.value||'').toLowerCase();
          const dMin = Number(minD.value)||0; const dMax = Number(maxD.value)||Infinity;
          return (items||[]).filter((x)=>{
            const pr = Number((x.price_from||'').toString().replace(/\D/g,''))||0;
            const okPrice = pr>=min && pr<=max;
            const okAct = !a || (x.meta||'').toLowerCase().includes(a);
            const dur = Number(x.duration_days||x.duration||0) || 0;
            const okDur = dur>=dMin && dur<=dMax;
            return okPrice && okAct && okDur;
          });
        }
        // persist filters/search
        const persist=()=>{
          try{ localStorage.setItem('kt_filters', JSON.stringify({ q:q.value, minP:minP.value, maxP:maxP.value, minD:minD.value, maxD:maxD.value, act:act.value })); }catch(_){ }
        };
        const restore=()=>{
          try{ const s=JSON.parse(localStorage.getItem('kt_filters')||'{}'); if(!s) return; q.value=s.q||''; minP.value=s.minP||''; maxP.value=s.maxP||''; minD.value=s.minD||''; maxD.value=s.maxD||''; act.value=s.act||''; }catch(_){ }
        };
        restore();
        async function searchRemote(query){
          const s=(query||'').trim();
          if(!s){ render(localFilter(all)); return; }
          try{
            const r=await fetch('/api/tg/search?q='+encodeURIComponent(s));
            if(!r.ok){ render(all); return; }
            const json=await r.json();
            let items=Array.isArray(json?.items)? json.items: [];
            items = localFilter(items);
            const lang=getLang();
            render(items.map(x=>({
              id:x.id,
              title:pickI18n(x,'title',lang),
              img:x.image||'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
              meta:`${x.activity||''} ‚Ä¢ ${x.region||''}`.trim(),
              price:(x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+' ‚ÇΩ':'–ø–æ –∑–∞–ø—Ä–æ—Å—É')
            })));
          }catch(_){ render(all); }
        }
        let tmr; q.addEventListener('input',()=>{ persist(); clearTimeout(tmr); tmr=setTimeout(()=>searchRemote(q.value),200); });
        btn.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='flex'; });
        sbtn.addEventListener('click',(e)=>{ e.preventDefault(); persist(); searchRemote(q.value); });
        close.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='none'; });
        apply.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='none'; persist(); searchRemote(q.value); });
        chips.forEach((chip)=>{
          chip.addEventListener('click',(e)=>{
            e.preventDefault();
            const v = chip.getAttribute('data-act')||'';
            const isActive = chip.classList.contains('active');
            chips.forEach(c=>c.classList.remove('active'));
            if(isActive){ act.value=''; searchRemote(q.value); return; }
            chip.classList.add('active'); act.value = v; searchRemote(q.value);
          });
        });
        // initial render with restored filters
        searchRemote(q.value);
      })();
    </script>
    <script>
      (function(){
        async function loadIconForChip(chip){
          try{
            const term=chip.getAttribute('data-act')||'';
            if(!term) return;
            const r=await fetch('/api/icons/noun?q='+encodeURIComponent(term));
            if(!r.ok) return;
            const j=await r.json();
            const url=j?.icon?.preview || j?.icon?.svg_url; if(!url) return;
            const svg=chip.querySelector('svg');
            const img=document.createElement('img'); img.src=url; img.width=16; img.height=16; img.alt=term; img.style.display='block';
            if(svg){ svg.replaceWith(img); } else { chip.prepend(img); }
          }catch(_){ }
        }
        const chips=document.querySelectorAll('#chips .chip');
        chips.forEach((c,i)=>{ if(i<10) loadIconForChip(c); });
      })();
    </script>
  </body>
  </html>

