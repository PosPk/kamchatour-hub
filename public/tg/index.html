<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Kamchatour — Витрина</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root{
        --tg-bg: var(--tg-theme-bg-color, #f8fafc);
        --tg-text: var(--tg-theme-text-color, #0f172a);
        --tg-hint: var(--tg-theme-hint-color, #64748b);
        --tg-button: var(--tg-theme-button-color, #0891b2);
        --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
        --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
      }
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--tg-bg);color:var(--tg-text)}
      .wrap{padding:16px;padding-bottom:92px}
      .grid{display:grid;grid-template-columns:1fr;gap:12px}
      .card{background:var(--tg-secondary-bg);border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;position:relative}
      .cover{width:100%;height:160px;object-fit:cover;background:#e2e8f0}
      .gallery{display:flex;gap:8px;overflow:auto;scroll-snap-type:x mandatory;padding:8px}
      .slide{flex:0 0 80%;max-width:80%;height:160px;border-radius:10px;overflow:hidden;scroll-snap-align:start;border:1px solid #e2e8f0;background:#e2e8f0}
      .slide img{width:100%;height:100%;object-fit:cover;display:block}
      .pad{padding:12px}
      .title{font-weight:800}
      .meta{color:var(--tg-hint);margin-top:4px}
      .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
      .price{color:#065f46;font-weight:800}
      .btn{display:inline-block;background:var(--tg-button);color:var(--tg-button-text);padding:10px 12px;border-radius:10px;text-decoration:none}
      .search{display:flex;gap:8px;margin-bottom:12px}
      .input{flex:1;padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
      .empty{padding:24px;text-align:center;color:#64748b}
      .bottom{position:fixed;left:0;right:0;bottom:calc(12px + env(safe-area-inset-bottom));display:flex;justify-content:center;z-index:999;pointer-events:none}
      .bottom .dock{display:flex;gap:18px;justify-content:space-around;align-items:center;background:rgba(255,255,255,.9);backdrop-filter:blur(14px);padding:10px 12px;border:1px solid rgba(2,6,23,.08);border-radius:20px;box-shadow:0 12px 30px rgba(2,6,23,.18);pointer-events:auto}
      .link{color:#0f172a;text-decoration:none;border-radius:14px;background:transparent;display:flex;flex-direction:column;align-items:center;justify-content:center;width:64px;height:64px;gap:4px;transition:background .2s ease,color .2s ease}
      .link:hover{background:rgba(2,6,23,.06)}
      .link.active{background:rgba(8,145,178,.15);color:#0891b2}
      .link svg{width:22px;height:22px;display:block;stroke:currentColor}
      .link .lbl{font-size:11px;line-height:12px;color:currentColor}
      .modal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:flex-end}
      .sheet{background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;width:100%}
      .row2{display:flex;gap:8px}
      .label{font-size:12px;color:#475569;margin:4px 0}
      .chips{display:flex;gap:8px;overflow:auto;padding-bottom:8px;margin-bottom:8px}
      .chip{display:flex;align-items:center;gap:6px;border:1px solid #e2e8f0;border-radius:999px;padding:8px 10px;background:#fff;color:#0f172a;white-space:nowrap}
      .chip svg{width:16px;height:16px}
      .chip.active{border-color:var(--tg-button);background:color-mix(in srgb, var(--tg-button) 15%, #fff)}
      /* badges */
      .badges{position:absolute;top:8px;right:8px;display:flex;gap:6px}
      .badge{backdrop-filter:blur(4px);background:rgba(0,0,0,.55);color:#fff;border-radius:999px;padding:4px 8px;font-size:12px}
      .badge.eco{background:rgba(16,185,129,.85)}
      .badge.rating{background:rgba(234,179,8,.9)}
      .badge.hit{background:rgba(59,130,246,.9)}
      .badge.discount{background:rgba(244,63,94,.9)}
      /* skeleton */
      .skeleton{background:linear-gradient(90deg,#e5e7eb, #f3f4f6 40%, #e5e7eb 60%);background-size:200% 100%;animation:sh 1.2s infinite}
      @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
      .card.sk .cover{background:#e5e7eb}
      .card.sk .title,.card.sk .meta,.card.sk .price{height:14px;border-radius:6px}
    </style>
    <script>
      function initTelegram(){
        try{ var tg=window.Telegram && window.Telegram.WebApp; if(tg){ tg.expand(); tg.ready(); } }catch(_){ }
      }
      function getLang(){
        const p=new URLSearchParams(location.search);
        const urlLang=(p.get('lang')||'').toLowerCase();
        if(urlLang) return urlLang;
        try{
          const tg = window.Telegram && window.Telegram.WebApp;
          const lc = tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.language_code;
          if(lc){ if(lc.toLowerCase().startsWith('zh')) return 'zh'; if(lc.toLowerCase().startsWith('ru')) return 'ru'; }
        }catch(_){ }
        const nav=(navigator.language||'').toLowerCase();
        if(nav.startsWith('zh')) return 'zh';
        if(nav.startsWith('ru')) return 'ru';
        return 'ru';
      }
      function pickI18n(obj,key,lang){
        const base=obj[key];const i18n=(obj[key+"_i18n"]||{});
        return (i18n && i18n[lang]) || base;
      }
      function opt(u,w){
        try{
          if(!u) return u;
          if(u.includes('supabase.co/storage/v1/object/public/')){
            var url=new URL(u);
            url.pathname=url.pathname.replace('/object/public/','/render/image/public/');
            url.searchParams.set('width', String(w||720));
            url.searchParams.set('quality','70');
            url.searchParams.set('format','webp');
            return url.toString();
          }
          var noProto=u.replace(/^https?:\/\//,'');
          return 'https://images.weserv.nl/?url='+encodeURIComponent(noProto)+'&w='+(w||720)+'&q=70&output=webp';
        }catch(_){ return u; }
      }
      async function authIfPossible(){
        try{ var tg=window.Telegram&&window.Telegram.WebApp; var initData=tg&&tg.initData; if(initData){ await fetch('/api/tg/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData})}); } }catch(_){ }
      }
      async function loadTours(){
        try{
          const res = await fetch('/api/tg/tours',{cache:'no-store'});
          if(res.ok){
            const json = await res.json();
            const items = Array.isArray(json?.items)? json.items: [];
            const lang=getLang();
            return items.map(x=>({
              id: x.id,
              title: pickI18n(x,'title',lang),
              img: x.image || 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
              gallery: Array.isArray(x.images)? x.images : (Array.isArray(x.gallery)? x.gallery : (Array.isArray(x.photos)? x.photos : (x.image?[x.image]:[]))),
              meta: `${x.activity || ''} • ${x.region || ''}`.trim(),
              price: (x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+ ' ₽' : 'по запросу'),
              eco_points: x.eco_points || 0,
              rating: x.rating || null,
              reviews: x.reviews || null,
              duration_days: x.duration_days || x.duration || null,
              price_from: x.price_from || null
            }));
          }
          const res2 = await fetch('/partner-tours.json',{cache:'no-store'});
          if(!res2.ok) return [];
          const data = await res2.json();
          const lang=getLang();
          return data.map(x=>({
            id: x.id,
            title: pickI18n(x,'title',lang),
            img: x.image,
            gallery: Array.isArray(x.images)? x.images : (Array.isArray(x.gallery)? x.gallery : (Array.isArray(x.photos)? x.photos : (x.image?[x.image]:[]))),
            meta: `${x.activity || ''} • ${x.region || ''}`.trim(),
            price: (x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+ ' ₽' : 'по запросу'),
            eco_points: x.eco_points || 0,
            rating: x.rating || null,
            reviews: x.reviews || null,
            duration_days: x.duration_days || x.duration || null,
            price_from: x.price_from || null
          }));
        }catch(_){ return []; }
      }
    </script>
  </head>
  <body>
    <div style="display:none">@@include('/tg/icons.svg')</div>
    <div class="wrap">
      <h1 class="title">Туры Камчатки</h1>
      <div class="search">
        <input id="q" class="input" type="search" placeholder="Поиск по названию и описанию"/>
        <a id="searchBtn" class="btn" href="#">Поиск</a>
        <a id="filtersBtn" class="btn" href="#">Фильтры</a>
      </div>
      <div id="chips" class="chips">
        <a class="chip" data-act="вулканы" href="#" title="Вулканы" aria-label="Вулканы">
          <svg width="16" height="16"><use href="/tg/icons.svg#volcano"/></svg>
          <span>Вулканы</span>
        </a>
        <a class="chip" data-act="долина гейзеров" href="#" title="Гейзеры" aria-label="Гейзеры">
          <svg width="16" height="16"><use href="/tg/icons.svg#geyser"/></svg>
          <span>Гейзеры</span>
        </a>
        <a class="chip" data-act="хайкинг" href="#" title="Хайкинг" aria-label="Хайкинг">
          <svg width="16" height="16"><use href="/tg/icons.svg#hiking"/></svg>
          <span>Хайкинг</span>
        </a>
        <a class="chip" data-act="медведи" href="#" title="Медведи" aria-label="Медведи">
          <svg width="16" height="16"><use href="/tg/icons.svg#bear"/></svg>
          <span>Медведи</span>
        </a>
        <a class="chip" data-act="рыбалка" href="#" title="Рыбалка" aria-label="Рыбалка">
          <svg width="16" height="16"><use href="/tg/icons.svg#fishing"/></svg>
          <span>Рыбалка</span>
        </a>
        <a class="chip" data-act="морские туры" href="#" title="Море" aria-label="Море">
          <svg width="16" height="16"><use href="/tg/icons.svg#sea"/></svg>
          <span>Море</span>
        </a>
        <a class="chip" data-act="киты" href="#" title="Киты" aria-label="Киты">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12c4 0 6-3 10-3s6 3 10 3c-1 3-4 6-8 6-5 0-9-3-12-6z"/><circle cx="8" cy="11" r="1"/></svg>
          <span>Киты</span>
        </a>
        <a class="chip" data-act="вертолёт" href="#" title="Вертолёт" aria-label="Вертолёт">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18"/><path d="M4 10h6l6 3h4"/><circle cx="6" cy="15" r="2"/><circle cx="18" cy="15" r="2"/></svg>
          <span>Вертолёт</span>
        </a>
        <a class="chip" data-act="снегоход" href="#" title="Снегоход" aria-label="Снегоход">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18h6l4-4 4 2 4 2"/><path d="M5 18l-3 2"/></svg>
          <span>Снегоход</span>
        </a>
        <a class="chip" data-act="дог-слидинг" href="#" title="Дог-слидинг" aria-label="Дог-слидинг">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 16l6 2 6-2 4 2"/><path d="M4 14l2-3 3 2 2-2"/></svg>
          <span>Дог‑слидинг</span>
        </a>
        <a class="chip" data-act="рафтинг" href="#" title="Рафтинг" aria-label="Рафтинг">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 15c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2"/><path d="M6 12l2-3m8 3l-2-3"/></svg>
          <span>Рафтинг</span>
        </a>
        <a class="chip" data-act="сёрфинг" href="#" title="Сёрфинг" aria-label="Сёрфинг">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18c3 0 3-2 6-2s3 2 6 2 3-2 6-2"/><path d="M10 6c2 2 2 4 0 6"/></svg>
          <span>Сёрфинг</span>
        </a>
        <a class="chip" data-act="термы" href="#" title="Термы" aria-label="Термы">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 18h12"/><path d="M8 14c0-2 2-3 4-3s4 1 4 3"/><path d="M10 10c-1-1-1-3 0-4"/></svg>
          <span>Термы</span>
        </a>
        <a class="chip" data-act="каякинг" href="#" title="Каякинг" aria-label="Каякинг">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12l10-6 10 6-10 6z"/><path d="M12 6v12"/></svg>
          <span>Каякинг</span>
        </a>
        <a class="chip" data-act="этно" href="#" title="Этно" aria-label="Этно">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3 7h7l-5.5 4 2.5 7-7-4-7 4 2.5-7L2 9h7z"/></svg>
          <span>Этно</span>
        </a>
        <a class="chip" data-act="фототур" href="#" title="Фототур" aria-label="Фототур">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"/><circle cx="12" cy="12" r="3"/></svg>
          <span>Фототур</span>
        </a>
        <a class="chip" data-act="4x4" href="#" title="4x4" aria-label="4x4">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="8" width="18" height="7" rx="2"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>
          <span>4x4</span>
        </a>
      </div>
      <div id="list" class="grid"></div>
    </div>
    <div id="ai" class="modal">
      <div class="sheet">
        <div class="label">AI‑подбор</div>
        <input id="aiq" class="input" type="text" placeholder="Например: 3 дня, вулканы, до 50 тыс"/>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <a id="closeAi" class="link" href="#">← Вернуться</a>
          <a id="runAi" class="btn" href="#">Подобрать</a>
        </div>
      </div>
    </div>
    <div id="filters" class="modal">
      <div class="sheet">
        <div class="label">Цена (₽)</div>
        <div class="row2">
          <input id="minPrice" class="input" type="number" placeholder="от"/>
          <input id="maxPrice" class="input" type="number" placeholder="до"/>
        </div>
        <div class="label">Длительность (дней)</div>
        <div class="row2">
          <input id="minDays" class="input" type="number" placeholder="от"/>
          <input id="maxDays" class="input" type="number" placeholder="до"/>
        </div>
        <div class="label">Активность</div>
        <input id="act" class="input" type="text" placeholder="рыбалка, вулканы..."/>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <a id="closeFilters" class="link" href="#">Отмена</a>
          <a id="applyFilters" class="btn" href="#">Применить</a>
        </div>
      </div>
    </div>
    <div class="bottom"><div class="dock">
      <a class="link" data-path="/tg/" href="/tg" title="Каталог" aria-label="Каталог">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18M3 10h18M3 16h18"/></svg>
        <span class="lbl">Каталог</span>
      </a>
      <a class="link" data-path="/tg/map.html" href="/tg/map.html" title="Карта" aria-label="Карта">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6l6-3 6 3 6-3v15l-6 3-6-3-6 3z"/><path d="M9 3v15"/><path d="M15 6v15"/></svg>
        <span class="lbl">Карта</span>
      </a>
      <a class="link" data-path="/tg/story.html" href="/tg/story.html" title="История" aria-label="История">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4v16"/><path d="M20 22V6H6.5A2.5 2.5 0 0 0 4 8.5"/></svg>
        <span class="lbl">История</span>
      </a>
      <a class="link" data-path="/tg/events.html" href="/tg/events.html" title="События" aria-label="События">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
        <span class="lbl">События</span>
      </a>
      <a class="link" data-path="/tg/account.html" href="/tg/account.html" title="Аккаунт" aria-label="Аккаунт">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M6 20c0-3.3137 2.6863-6 6-6s6 2.6863 6 6"/></svg>
        <span class="lbl">Аккаунт</span>
      </a>
    </div></div>
    <script>
      (async()=>{
        initTelegram();
        authIfPossible();
        const all = await loadTours();
        const el=document.getElementById('list');
        const q=document.getElementById('q');
        const modal=document.getElementById('filters');
        const btn=document.getElementById('filtersBtn');
        const sbtn=document.getElementById('searchBtn');
        const aiModal=document.getElementById('ai');
        const aiq=document.getElementById('aiq');
        const runAi=document.getElementById('runAi');
        const closeAi=document.getElementById('closeAi');
        const close=document.getElementById('closeFilters');
        const apply=document.getElementById('applyFilters');
        const minP=document.getElementById('minPrice');
        const maxP=document.getElementById('maxPrice');
        const minD=document.getElementById('minDays');
        const maxD=document.getElementById('maxDays');
        const act=document.getElementById('act');
        const chips=document.querySelectorAll('#chips .chip');
        function render(items){
          el.innerHTML='';
          const lang=getLang();
          if(!items || items.length===0){
            el.innerHTML = '<div class="empty">🐻 Нет результатов.<br/>Попробуйте изменить поиск или выбрать другую активность.</div>';
            return;
          }
          (items||[]).forEach(t=>{
            const c=document.createElement('a');
            c.href=`/tg/tour.html?id=${encodeURIComponent(t.id)}&lang=${lang}`;
            c.className='card';
            c.style.textDecoration='none';
            const eco = (t.eco_points||0)>0? `<span class="badge eco">♻️ Eco+${t.eco_points}</span>`:'';
            const rating = t.rating? `<span class="badge rating">★ ${t.rating}${t.reviews? ` (${t.reviews})`:''}</span>`:'';
            const hit = (t.rating||0) >= 4.7? `<span class="badge hit">Хит</span>`:'';
            const slides = (Array.isArray(t.gallery) && t.gallery.length>0? t.gallery: [t.img]).slice(0,3);
            const gallery = `<div class="gallery">${slides.map((u)=>{
                const s360=opt(u,360), s720=opt(u,720);
                const srcset=`${s360} 360w, ${s720} 720w`;
                return `<div class=\"slide\"><img src=\"${s720}\" srcset=\"${srcset}\" sizes=\"(max-width: 640px) 80vw, 512px\" loading=\"lazy\" decoding=\"async\"/></div>`;
              }).join('')}</div>`;
            const mapUrl = `/tg/map.html?id=${encodeURIComponent(t.id)}`;
            c.innerHTML=`<div class="badges">${eco}${hit}${rating}</div>${gallery}<div class="pad"><div class="title">${t.title}</div><div class="meta">${t.meta}</div><div class="row"><div class="price">${t.price}</div><span class="btn">Подробнее</span></div><div class="row" style="margin-top:6px"><a class="link" href="${mapUrl}" style="text-decoration:none;color:#0891b2">На карте →</a></div></div>`;
            el.appendChild(c);
          });
        }
        // show skeletons while loading initial
        (function showSkeleton(){
          const skeletonGrid=document.getElementById('list'); skeletonGrid.innerHTML='';
          for(let i=0;i<4;i++){
            const s=document.createElement('div'); s.className='card sk'; s.innerHTML=`<div class="cover skeleton"></div><div class="pad"><div class="title skeleton" style="width:70%"></div><div class="meta skeleton" style="width:40%;margin-top:6px"></div><div class="row"><div class="price skeleton" style="width:80px"></div><span class="btn skeleton" style="width:96px;height:36px;border-radius:10px"></span></div></div>`; skeletonGrid.appendChild(s);
          }
        })();
        function localFilter(items){
          const min = Number(minP.value)||0; const max = Number(maxP.value)||Infinity; const a = (act.value||'').toLowerCase();
          const dMin = Number(minD.value)||0; const dMax = Number(maxD.value)||Infinity;
          return (items||[]).filter((x)=>{
            const pr = Number((x.price_from||'').toString().replace(/\D/g,''))||0;
            const okPrice = pr>=min && pr<=max;
            const okAct = !a || (x.meta||'').toLowerCase().includes(a);
            const dur = Number(x.duration_days||x.duration||0) || 0;
            const okDur = dur>=dMin && dur<=dMax;
            return okPrice && okAct && okDur;
          });
        }
        // persist filters/search
        const persist=()=>{
          try{ localStorage.setItem('kt_filters', JSON.stringify({ q:q.value, minP:minP.value, maxP:maxP.value, minD:minD.value, maxD:maxD.value, act:act.value })); }catch(_){ }
        };
        const restore=()=>{
          try{ const s=JSON.parse(localStorage.getItem('kt_filters')||'{}'); if(!s) return; q.value=s.q||''; minP.value=s.minP||''; maxP.value=s.maxP||''; minD.value=s.minD||''; maxD.value=s.maxD||''; act.value=s.act||''; }catch(_){ }
        };
        restore();
        async function searchRemote(query){
          const s=(query||'').trim();
          if(!s){ render(localFilter(all)); return; }
          try{
            const r=await fetch('/api/tg/search?q='+encodeURIComponent(s));
            if(!r.ok){ render(all); return; }
            const json=await r.json();
            let items=Array.isArray(json?.items)? json.items: [];
            items = localFilter(items);
            const lang=getLang();
            render(items.map(x=>({
              id:x.id,
              title:pickI18n(x,'title',lang),
              img:x.image||'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
              meta:`${x.activity||''} • ${x.region||''}`.trim(),
              price:(x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+' ₽':'по запросу')
            })));
          }catch(_){ render(all); }
        }
        let tmr; q.addEventListener('input',()=>{ persist(); clearTimeout(tmr); tmr=setTimeout(()=>searchRemote(q.value),200); });
        btn.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='flex'; });
        sbtn.addEventListener('click',(e)=>{ e.preventDefault(); persist(); searchRemote(q.value); });
        // AI button in chips bar
        const aiBtn=document.createElement('a'); aiBtn.className='chip'; aiBtn.href='#'; aiBtn.textContent='AI‑подбор';
        document.getElementById('chips').prepend(aiBtn);
        aiBtn.addEventListener('click',(e)=>{ e.preventDefault(); aiModal.style.display='flex'; });
        closeAi.addEventListener('click',(e)=>{ e.preventDefault(); aiModal.style.display='none'; });
        runAi.addEventListener('click', async (e)=>{
          e.preventDefault();
          try{
            // 1) Partial render (мгновенно): простой локальный подбор по введённой фразе
            const qv=(aiq.value||q.value||'').toLowerCase().split(/[\s,]+/).filter(Boolean);
            const draft=(all||[]).filter(it=>{
              const hay=((it.title||'')+' '+(it.meta||'')).toLowerCase();
              return qv.length===0? true: qv.some(t=>hay.includes(t));
            }).slice(0,12);
            if(draft.length){ render(draft); }
            // Показать индикатор «идёт подбор»
            const note=document.createElement('div'); note.id='aiNote'; note.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:92px;background:rgba(2,6,23,.85);color:#fff;padding:6px 10px;border-radius:10px;font-size:12px;z-index:1000'; note.textContent='AI‑подбор…'; document.body.appendChild(note);
            // 2) Финальный результат от AI
            const r=await fetch('/api/ai/recommend',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:aiq.value||q.value||''})});
            const j=await r.json();
            const items=Array.isArray(j?.items)? j.items: [];
            if(items.length){
              render(items.map(x=>({
                id:x.id, title:x.title, img:x.image, meta:`${x.activity||''} • ${x.region||''}`, price:(x.price_from? new Intl.NumberFormat('ru-RU').format(x.price_from)+' ₽':'по запросу')
              })));
            }
            aiModal.style.display='none';
            const n=document.getElementById('aiNote'); if(n) n.remove();
          }catch(_){
            aiModal.style.display='none';
            const n=document.getElementById('aiNote'); if(n) n.remove();
          }
        });
        close.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='none'; });
        apply.addEventListener('click',(e)=>{ e.preventDefault(); modal.style.display='none'; persist(); searchRemote(q.value); });
        chips.forEach((chip)=>{
          chip.addEventListener('click',(e)=>{
            e.preventDefault();
            const v = chip.getAttribute('data-act')||'';
            const isActive = chip.classList.contains('active');
            chips.forEach(c=>c.classList.remove('active'));
            if(isActive){ act.value=''; searchRemote(q.value); return; }
            chip.classList.add('active'); act.value = v; searchRemote(q.value);
          });
        });
        // initial render with restored filters
        searchRemote(q.value);
      })();
    </script>
    <script>
      (function(){
        async function loadIconForChip(chip){
          try{
            const term=chip.getAttribute('data-act')||'';
            if(!term) return;
            const r=await fetch('/api/icons/noun?q='+encodeURIComponent(term));
            if(!r.ok) return;
            const j=await r.json();
            const url=j?.icon?.preview || j?.icon?.svg_url; if(!url) return;
            const svg=chip.querySelector('svg');
            const img=document.createElement('img'); img.src=url; img.width=16; img.height=16; img.alt=term; img.title=term; img.style.display='block';
            if(svg){ svg.replaceWith(img); } else { chip.prepend(img); }
          }catch(_){ }
        }
        const chips=document.querySelectorAll('#chips .chip');
        chips.forEach((c,i)=>{ if(i<10) loadIconForChip(c); c.setAttribute('title', (c.getAttribute('data-act')||c.textContent||'').trim()); });
        // highlight active nav
        try{
          var path=location.pathname; var links=document.querySelectorAll('.bottom .link');
          links.forEach(function(a){ var p=a.getAttribute('data-path')||a.getAttribute('href'); if(path.endsWith('/')&&p.endsWith('/')){ if(path===p) a.classList.add('active'); } else if(path.endsWith('.html')){ if(path===p) a.classList.add('active'); } else if(path.startsWith(p)) { a.classList.add('active'); }});
        }catch(_){ }
      })();
    </script>
  </body>
  </html>

