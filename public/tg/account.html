<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0b1020;--text:#e5e7eb;--muted:#94a3b8;--card:#0f172a;--primary:#0891b2}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:var(--bg);color:var(--text)}
    .wrap{padding:16px 16px 96px}
    .top{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .btn{display:inline-block;background:rgba(255,255,255,.08);color:var(--text);text-decoration:none;padding:8px 12px;border-radius:10px;border:1px solid rgba(148,163,184,.25)}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.25);border-radius:12px;padding:14px;margin-bottom:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .role{display:flex;gap:10px;align-items:center;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.25);background:rgba(255,255,255,.04);cursor:pointer}
    .role.active{outline:2px solid var(--primary)}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top"><a class="btn" href="/tg">‚Üê –ù–∞–∑–∞–¥</a><h1 style="margin:0">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1></div>
    <div id="user" class="card">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è‚Ä¶</div>
    <div class="card">
      <div class="muted" style="margin-bottom:8px">–†–æ–ª—å –≤ —Å–∏—Å—Ç–µ–º–µ</div>
      <div class="grid" id="roles"></div>
    </div>
    <div class="card" id="opLevel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div>
          <div style="font-weight:600">–£—Ä–æ–≤–µ–Ω—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</div>
          <div class="muted" id="opCommission" style="font-size:13px">–ö–æ–º–∏—Å—Å–∏—è: ‚Äî</div>
        </div>
        <div>
          <select id="opSelect" class="btn" style="background:rgba(255,255,255,.08);border:1px solid rgba(148,163,184,.25)">
            <option value="L1">L1 (10%)</option>
            <option value="L2">L2 (7%)</option>
            <option value="L3">L3 (5%)</option>
          </select>
          <a id="opSave" class="btn" href="#">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</a>
        </div>
      </div>
    </div>
    <div class="card" id="shortcuts" style="display:none"></div>
    <div class="card" id="competencies" style="display:none"></div>
  </div>
  <script>
    function applyTheme(){
      try{ const tg=window.Telegram&&window.Telegram.WebApp; if(!tg) return; const p=tg.themeParams||{}; const c=(k,d)=> p[k]||d; document.documentElement.style.setProperty('--bg',c('bg_color','#0b1020')); document.documentElement.style.setProperty('--text',c('text_color','#e5e7eb')); document.documentElement.style.setProperty('--card',c('secondary_bg_color','#0f172a')); }catch(_){ }
    }
    applyTheme();

    function renderUser(u){
      const el=document.getElementById('user');
      const name=u?.name||''; const username=u?.username? ('@'+u.username):''; const role=u?.role||'traveler';
      el.innerHTML = `<div style="display:flex;align-items:center;gap:12px"><div style="width:44px;height:44px;border-radius:50%;background:#1f2937;display:flex;align-items:center;justify-content:center">üë§</div><div><div style="font-weight:600">${name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div><div class="muted" style="font-size:13px">${username} ¬∑ —Ä–æ–ª—å: ${role}</div></div></div>`;
      const op=document.getElementById('opLevel'); op.style.display= role==='operator'? 'block':'none';
    }

    function roleTile(key,title,emoji){
      const div=document.createElement('div'); div.className='role'; div.setAttribute('data-role',key);
      div.innerHTML=`<div style="font-size:20px">${emoji}</div><div><div style="font-weight:600">${title}</div><div class="muted" style="font-size:12px">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div></div>`;
      div.addEventListener('click', async ()=>{ await setRole(key); await loadMe(); renderShortcuts(key); });
      return div;
    }

    async function setRole(role){
      try{ await fetch('/api/tg/role',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role})}); localStorage.setItem('tg_role',role);}catch(_){ }
    }

    function renderRoles(current){
      const box=document.getElementById('roles'); box.innerHTML='';
      const roles=[ ['operator','–¢—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä','üèîÔ∏è'], ['traveler','–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫','üß≠'], ['rental','–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä','üèïÔ∏è'], ['transfer','–¢—Ä–∞–Ω—Å—Ñ–µ—Ä','üöê'], ['agent','–ê–≥–µ–Ω—Ç','ü§ù'] ];
      roles.forEach(([k,t,e])=>{ const item=roleTile(k,t,e); if(current===k) item.classList.add('active'); box.appendChild(item); });
    }

    function renderShortcuts(role){
      const box=document.getElementById('shortcuts');
      const map={
        operator:[ ['–ö–∞–±–∏–Ω–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä','/tg/dash-operator.html'], ['–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è','/tg'], ['–í—ã–ø–ª–∞—Ç—ã','/tg'] ],
        traveler:[ ['–ö–∞–±–∏–Ω–µ—Ç –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞','/tg/dash-traveler.html'], ['–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ','/tg'], ['–ü–æ–¥–¥–µ—Ä–∂–∫–∞','/tg'] ],
        rental:[
          ['–ö–∞–±–∏–Ω–µ—Ç –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞','/tg/dash-rental.html'],
          ['–ê—Ä–µ–Ω–¥–∞ –∂–∏–ª—å—è','/tg/dash-rental.html#housing'],
          ['–ê—Ä–µ–Ω–¥–∞ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è','/tg/dash-rental.html#gear'],
          ['–ê—Ä–µ–Ω–¥–∞ –∞–≤—Ç–æ','/tg/dash-rental.html#cars'],
          ['–ó–∞—è–≤–∫–∏','/tg'],
          ['–ö–∞–ª–µ–Ω–¥–∞—Ä—å','/tg']
        ],
        transfer:[ ['–ö–∞–±–∏–Ω–µ—Ç —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞','/tg/dash-transfer.html'], ['–ú–∞—Ä—à—Ä—É—Ç—ã','/tg'], ['–ó–∞—è–≤–∫–∏','/tg'] ],
        agent:[ ['–ö–∞–±–∏–Ω–µ—Ç –∞–≥–µ–Ω—Ç–∞','/tg/dash-agent.html'], ['–í—ã–ø–ª–∞—Ç—ã','/tg'], ['–ú–∞—Ç–µ—Ä–∏–∞–ª—ã','/tg'] ],
      };
      const items=(map[role]||[]).map(([t,href])=>`<a class="btn" href="${href}" style="margin-right:8px">${t}</a>`).join('');
      box.style.display='block'; box.innerHTML = `<div class="muted" style="margin-bottom:8px">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>${items}`;
    }

    function renderCompetencies(role){
      const box=document.getElementById('competencies');
      const map={
        operator:[ '–°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–æ–≤', '–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–∏–¥–æ–≤', '–ü–ª–∞—Ç–µ–∂–∏/–≤—ã–ø–ª–∞—Ç—ã', '–û—Ç—á—ë—Ç—ã –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º' ],
        traveler:[ '–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ç–∞–ª–æ–≥–∞', '–û—Å—Ç–∞–≤–∏—Ç—å –ª–∏–¥', '–û–ø–ª–∞—Ç–∞ —Ç—É—Ä–∞', '–õ–∏—á–Ω—ã–µ –∑–∞–∫–∞–∑—ã' ],
        rental:[ '–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç –∞—Ä–µ–Ω–¥—ã', '–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–Ω—è—Ç–æ—Å—Ç–∏', '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–æ–∫' ],
        transfer:[ '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏', '–ó–∞—è–≤–∫–∏ –Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä', '–°—Ç–∞—Ç—É—Å—ã –ø–æ–µ–∑–¥–æ–∫' ],
        agent:[ '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏', '–¢—Ä–µ–∫–∏–Ω–≥ –∑–∞—è–≤–æ–∫', '–í—ã–ø–ª–∞—Ç—ã –∞–≥–µ–Ω—Ç—É' ],
      };
      const items=(map[role]||[]).map((t)=>`<li>${t}</li>`).join('');
      box.style.display='block'; box.innerHTML = `<div style="font-weight:600;margin-bottom:8px">–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –∏ –¥–æ—Å—Ç—É–ø—ã</div><ul style="margin:0;padding-left:18px">${items}</ul>`;
    }

    async function loadOperatorLevel(){
      try{
        const r=await fetch('/api/tg/operator/level'); const j=await r.json(); const level=(j?.level||'L1');
        const sel=document.getElementById('opSelect'); sel.value=level;
        const cm={L1:0.10,L2:0.07,L3:0.05}; const pct=Math.round((cm[level]||0.10)*100);
        document.getElementById('opCommission').textContent='–ö–æ–º–∏—Å—Å–∏—è: '+pct+'%';
      }catch(_){ }
    }

    async function saveOperatorLevel(){
      try{
        const sel=document.getElementById('opSelect'); const level=sel.value; await fetch('/api/tg/operator/level',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({level})});
        await loadOperatorLevel();
      }catch(_){ }
    }

    async function loadMe(){
      try{ const r=await fetch('/api/tg/me'); const j=await r.json(); if(j?.ok){ renderUser(j.user); renderRoles(j.user?.role||'traveler'); renderShortcuts(j.user?.role||'traveler'); if((j.user?.role||'')==='operator'){ await loadOperatorLevel(); } return; } }catch(_){ }
      const lr=localStorage.getItem('tg_role')||'traveler'; renderUser({name:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', username:'', role:lr}); renderRoles(lr); renderShortcuts(lr); renderCompetencies(lr); if(lr==='operator'){ await loadOperatorLevel(); }
    }

    async function authIfPossible(){
      try{ const tg=window.Telegram&&window.Telegram.WebApp; const initData=tg?.initData||''; if(initData){ await fetch('/api/tg/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData})}); } }catch(_){ }
    }
    document.getElementById('opSave').addEventListener('click',(e)=>{ e.preventDefault(); saveOperatorLevel(); });
    authIfPossible().then(loadMe);
  </script>
</body>
</html>

