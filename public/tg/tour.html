<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>–¢—É—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>
    <style>
      :root{
        --tg-bg: var(--tg-theme-bg-color, #0b1020);
        --tg-text: var(--tg-theme-text-color, #e5e7eb);
        --tg-hint: var(--tg-theme-hint-color, #94a3b8);
        --tg-button: var(--tg-theme-button-color, #0891b2);
        --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
        --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #0f172a);
      }
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:var(--tg-bg);color:var(--tg-text)}
      .wrap{padding:16px;padding-bottom:92px}
      .hero{position:relative;border-radius:14px;overflow:hidden;height:260px}
      .hero img{width:100%;height:100%;object-fit:cover;display:block}
      .hero .grad{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.0),rgba(0,0,0,.55) 55%, rgba(0,0,0,.9))}
      .hero .txt{position:absolute;left:12px;right:12px;bottom:12px}
      .title{font-weight:800;font-size:22px;margin:0}
      .meta{color:var(--tg-hint);margin-top:4px}
      .card{background:var(--tg-secondary-bg);border:1px solid rgba(148,163,184,.2);border-radius:12px;padding:12px;margin-top:12px}
      .price{color:#86efac;font-weight:800}
      .btn{display:inline-block;background:var(--tg-button);color:var(--tg-button-text);padding:10px 12px;border-radius:10px;text-decoration:none}
      .toprow{display:flex;gap:8px;align-items:center;margin-bottom:8px}
      .trust{display:flex;gap:8px;align-items:center;color:#a7f3d0}
      .sticky-cta{position:fixed;left:16px;right:16px;bottom:76px;z-index:10}
      .sticky-cta .sheet{display:flex;justify-content:space-between;gap:12px;align-items:center;background:rgba(15,23,42,.8);backdrop-filter:blur(8px);border:1px solid rgba(148,163,184,.25);border-radius:14px;padding:10px 12px}
      .btn-pay{background:#22c55e;color:#062; border:none;border-radius:10px;padding:10px 12px}
    </style>
    <script>
      function initTelegram(){
        try{ var tg=window.Telegram && window.Telegram.WebApp; if(tg){ tg.expand(); tg.ready(); } }catch(_){ }
      }
      function getLang(){
        const p=new URLSearchParams(location.search);
        const lang=(p.get('lang')||'ru').toLowerCase();
        return lang;
      }
      function pickI18n(obj,key,lang){ const base=obj[key]; const i18n=(obj[key+"_i18n"]||{}); return (i18n&&i18n[lang])||base; }
      function opt(u,w){
        try{
          if(!u) return u;
          if(u.includes('supabase.co/storage/v1/object/public/')){
            var url=new URL(u);
            url.pathname=url.pathname.replace('/object/public/','/render/image/public/');
            url.searchParams.set('width', String(w||960));
            url.searchParams.set('quality','70');
            url.searchParams.set('format','webp');
            return url.toString();
          }
          var noProto=u.replace(/^https?:\/\//,'');
          return 'https://images.weserv.nl/?url='+encodeURIComponent(noProto)+'&w='+(w||960)+'&q=70&output=webp';
        }catch(_){ return u; }
      }
      async function getTour(){
        const p=new URLSearchParams(location.search); const id=p.get('id'); if(!id) return null;
        const res=await fetch('/partner-tours.json',{cache:'no-store'}); if(!res.ok) return null; const data=await res.json();
        return data.find((x)=>String(x.id)===String(id));
      }
    </script>
  </head>
  <body>
    <div class="wrap">
      <div id="content"></div>
    </div>
    <div class="sticky-cta" id="stickyCta" style="display:none">
      <div class="sheet">
        <div class="trust">‚úÖ –ö–æ–º–∏—Å—Å–∏—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç—É—Ä–∞</div>
        <a id="ctaLink" class="btn" href="#">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</a>
      </div>
    </div>
    <script>
      (async()=>{
        initTelegram();
        const lang=getLang();
        const t=await getTour(); if(!t){ document.getElementById('content').innerHTML='<div class="card">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
        const title=pickI18n(t,'title',lang);
        const desc=pickI18n(t,'description',lang);
        const price=(t.price_from? new Intl.NumberFormat('ru-RU').format(t.price_from)+' ‚ÇΩ' : '–ø–æ –∑–∞–ø—Ä–æ—Å—É');
        const meta=`${t.activity||''} ‚Ä¢ ${t.region||''} ‚Ä¢ ${t.duration_days||''} –¥–Ω.`;
        const urlLead=`/tg/lead.html?tour_id=${encodeURIComponent(t.id)}`;
        const backUrl=document.referrer && document.referrer.includes('/tg')? document.referrer : '/tg';
        // recently viewed (store)
        try{
          const rvKey='kt_recent';
          const cur={ id: (t.id||''), title:(title||''), img:(t.image||'') };
          const arr=JSON.parse(localStorage.getItem(rvKey)||'[]').filter((x)=>x&&x.id!==cur.id);
          arr.unshift(cur); localStorage.setItem(rvKey, JSON.stringify(arr.slice(0,8)));
        }catch(_){ }

        const cover720=opt(t.image||'',720), cover1080=opt(t.image||'',1080), cover1440=opt(t.image||'',1440);
        const coverSet=`${cover720} 720w, ${cover1080} 1080w, ${cover1440} 1440w`;
        const html=`
          <div class="toprow"><a class="btn" href="${backUrl}">‚Üê –ù–∞–∑–∞–¥</a></div>
          <div class="hero"><img src="${cover1080}" srcset="${coverSet}" sizes="100vw" alt="${title||''}" loading="lazy" decoding="async"/><div class="grad"></div><div class="txt"><h1 class="title">${title||''}</h1><div class="meta">${meta}</div></div></div>
          <div class="card"><div class="price">${price}</div><p>${desc||''}</p>
            <div class="trust">üîí –ì–∞—Ä–∞–Ω—Ç–∏—è: –¥–µ–ø–æ–∑–∏—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –∫–æ–º–∏—Å—Å–∏—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</div>
          </div>`;
        document.getElementById('content').innerHTML=html;
        const cta=document.getElementById('stickyCta'); const ctaLink=document.getElementById('ctaLink'); ctaLink.href=urlLead; cta.style.display='block';
        try{ var tg=window.Telegram && window.Telegram.WebApp; if(tg){ tg.MainButton.setText('–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É'); tg.MainButton.onClick(()=>{ location.href=urlLead; }); tg.MainButton.show(); } }catch(_){ }

        // CloudPayments quick pay
        try{
          const r=await fetch('/api/payment/config');
          if(r.ok){
            const cfg=await r.json();
            if(cfg?.enabled && cfg?.publicId){
              const payBtn=document.createElement('button');
              payBtn.className='btn-pay'; payBtn.textContent='–û–ø–ª–∞—Ç–∏—Ç—å –æ–Ω–ª–∞–π–Ω';
              document.querySelector('.sheet')?.appendChild(payBtn);
              payBtn.addEventListener('click',()=>{
                const amount = Number(t.price_from||0) || 1;
                const widget = (window.cp) && new window.cp.CloudPayments();
                if(!widget){ alert('–ü–ª–∞—Ç—ë–∂–Ω—ã–π –≤–∏–¥–∂–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
                widget.pay('charge', {
                  publicId: cfg.publicId,
                  description: title || '–¢—É—Ä',
                  amount, currency: 'RUB',
                  invoiceId: String(t.id||''),
                  accountId: 'tg_web',
                  skin: 'mini',
                  data: { tour_id: t.id }
                }, {
                  onSuccess: function(){ alert('–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç–∞'); },
                  onFail: function(){ alert('–û–ø–ª–∞—Ç–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'); },
                  onComplete: function(){ /* webhooks –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞—Ç—É—Å */ }
                });
              });
            }
          }
        }catch(_){ }
      })();
    </script>
  </body>
  </html>

